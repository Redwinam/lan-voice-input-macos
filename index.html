<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>å±€åŸŸç½‘è¯­éŸ³è¾“å…¥</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    body { font-family: sans-serif; padding: 16px; }
    textarea { width: 100%; height: 140px; font-size: 18px; padding: 12px; margin-top: 12px; border-radius: 10px; border: 1px solid #ddd;box-sizing: border-box;resize: vertical; display: block ;overflow: auto;  }
    button { font-size: 18px; padding: 12px 16px; margin-right: 8px; margin-top: 10px; border-radius: 10px; border: 1px solid #d7d7d7; background: #f7f7f7; color: #222; box-shadow: 0 1px 0 rgba(0,0,0,0.04); }
    button:active { transform: translateY(1px); }
    #log { margin-top: 14px; white-space: pre-wrap; border: 1px solid #ddd; padding: 10px; border-radius: 8px; min-height: 120px; }
    .status { margin-top: 10px; font-size: 14px; color: #555; }
    .hint { margin-top: 10px; font-size: 13px; color: #666; line-height: 1.4; }
    code { background: #f7f7f7; padding: 2px 6px; border-radius: 6px; }
    .mode-row { display: flex; justify-content: space-between; align-items: center; gap: 12px; }
    .mode-btn { font-size: 15px; padding: 8px 12px; border-radius: 999px; }
    .mode-btn.active { background: #ffe5d6; border-color: #f6a17c; color: #7a2b12; }
    .action-btn { background: #fff; border-color: #cfcfcf; }
    .action-btn:hover { background: #f2f2f2; }
  </style>
</head>
<body>
  <h2>æ‰‹æœºè¾“å…¥ â†’ ç”µè„‘åŒæ­¥</h2>

  <div class="hint">
    âœ… ä½¿ç”¨æ­¥éª¤:ç‚¹å‡»è¾“å…¥æ¡† â†’ è°ƒèµ·é”®ç›˜ â†’ ğŸ™è¯­éŸ³è¾“å…¥<br/>
  </div>
  <div class="mode-row">
    <button id="modeTextBtn" class="mode-btn active">âœ æ–‡å­—</button>
    <button id="modeCmdBtn" class="mode-btn">âš¡ å‘½ä»¤</button>
  </div>
  <div style="margin-top: 12px; display: flex; align-items: center; justify-content: flex-end; gap: 8px;">
    <input type="checkbox" id="manualModeCheck" style="transform: scale(1.3); cursor: pointer;">
    <label for="manualModeCheck" style="font-size: 16px; color: #333; cursor: pointer; font-weight: bold;">â˜‘ï¸ ä»…æ‰‹åŠ¨å‘é€ (è¾“å…¥å®Œç‚¹å‘é€)</label>
  </div>
  <div style="width: 100%">
    <textarea id="inputBox" placeholder="ç‚¹å‡»è¿™é‡Œè°ƒèµ·è¾“å…¥æ³•ï¼ˆæ¨èç”¨æ‰‹æœºé”®ç›˜è¯­éŸ³è¾“å…¥ï¼‰"></textarea>
  </div>
  <div>
    <button id="sendBtn" class="action-btn">ğŸ“¤ æ‰‹åŠ¨å‘é€</button>
    <button id="clearBtn" class="action-btn">ğŸ§¹ æ¸…ç©º</button>
    <button id="testBtn" style="display: none;">ğŸ§ª æµ‹è¯•æ³¨å…¥</button>
  </div>

  <div class="status" id="status">çŠ¶æ€ï¼šæœªè¿æ¥</div>
  <div id="log"></div>

<script>
let ws;
let timer = null;
let isComposing = false;
let currentMode = "text";

let lastSentText = "";
let lastSentMsg = "";
let lastSentTime = 0;
const DUP_WINDOW_MS = 1500;

function log(msg){
  const el = document.getElementById("log");
  el.textContent += msg + "\n";
  el.scrollTop = el.scrollHeight;
}

function setStatus(msg){
  document.getElementById("status").textContent = "çŠ¶æ€ï¼š" + msg;
}

function setMode(mode){
  currentMode = mode;
  document.getElementById("modeTextBtn").classList.toggle("active", mode === "text");
  document.getElementById("modeCmdBtn").classList.toggle("active", mode === "cmd");
  log("âœ… åˆ‡æ¢æ¨¡å¼ï¼š" + (mode === "text" ? "æ–‡å­—" : "å‘½ä»¤"));
}

function getWSFromQuery(){
  const url = new URL(location.href);
  return url.searchParams.get("ws");
}

async function resolveWSPort(){
  const wsFromQuery = getWSFromQuery();
  if(wsFromQuery) return wsFromQuery;

  // fallback: fetch /config
  try{
    const res = await fetch("/config");
    const cfg = await res.json();
    return cfg.ws_port;
  }catch(e){
    return 8765; // fallback
  }
}

async function connectWS(){
  const wsPort = await resolveWSPort();
  const wsUrl = `ws://${location.hostname}:${wsPort}`;
  ws = new WebSocket(wsUrl);

  ws.onopen = () => {
    setStatus("âœ… WebSocket å·²è¿æ¥");
    log("âœ… å·²è¿æ¥åˆ°ï¼š" + wsUrl);
  };

  ws.onclose = () => {
    setStatus("âŒ WebSocket æ–­å¼€");
    log("âŒ è¿æ¥æ–­å¼€");
  };

  ws.onerror = () => {
    setStatus("âŒ è¿æ¥é”™è¯¯");
    log("âŒ WebSocket é”™è¯¯");
  };

  ws.onmessage = (event) => {
    try{
      const data = JSON.parse(event.data);
      if(data && data.type === "cmd_result"){
        log("âœ… æ”¶åˆ°å‘½ä»¤ç»“æœï¼š" + data.message);
      }
    }catch(e){
      // ignore non-JSON
    }
  };
}
connectWS();

window.onload = () => {
  setTimeout(() => document.getElementById("inputBox").focus(), 200);
};

function sendText(text){
  text = (text || "").trim();
  if(!text) return;

  const now = Date.now();
  const dedupKey = currentMode + "::" + text;
  if(dedupKey === lastSentMsg && (now - lastSentTime) < DUP_WINDOW_MS){
    log("â­ï¸ å»é‡ï¼šçŸ­æ—¶é—´ç›¸åŒå†…å®¹ä¸å‘é€ -> " + text);
    return;
  }
  lastSentMsg = dedupKey;
  lastSentTime = now;

  if(ws && ws.readyState === 1){
    const payload = { type: currentMode, string: text };
    ws.send(JSON.stringify(payload));
    log("ğŸ“¤ å‘é€(" + (currentMode === "text" ? "æ–‡å­—" : "å‘½ä»¤") + ")ï¼š" + text);
  } else {
    log("âš ï¸ æœªè¿æ¥ WebSocketï¼Œæ— æ³•å‘é€");
  }
}

document.getElementById("sendBtn").onclick = () => {
  const box = document.getElementById("inputBox");
  sendText(box.value);
  box.value = "";
  lastSentText = "";
  box.focus();
};

document.getElementById("clearBtn").onclick = () => {
  const box = document.getElementById("inputBox");
  box.value = "";
  lastSentText = "";
  document.getElementById("log").textContent = "";
  box.focus();
};

document.getElementById("testBtn").onclick = () => {
  log("ğŸ§ª å‘é€æµ‹è¯•æ³¨å…¥æŒ‡ä»¤ï¼šè¯·æŠŠé¼ æ ‡æ”¾åœ¨è®°äº‹æœ¬è¾“å…¥åŒº");
  sendText("__TEST_INJECT__");
};

document.getElementById("modeTextBtn").onclick = () => setMode("text");
document.getElementById("modeCmdBtn").onclick = () => setMode("cmd");

const box = document.getElementById("inputBox");
box.addEventListener("compositionstart", () => isComposing = true);
box.addEventListener("compositionend", () => { isComposing = false; flushDelta(); });

box.addEventListener("input", () => {
  clearTimeout(timer);
  if(isComposing) return;
  timer = setTimeout(flushDelta, 500);
});

function flushDelta(){
  // å¦‚æœæ˜¯æ‰‹åŠ¨æ¨¡å¼ï¼Œä¸æ‰§è¡Œè‡ªåŠ¨å‘é€
  if(document.getElementById("manualModeCheck").checked) return;

  const current = box.value;
  if(!current.trim()) return;

  if(current.startsWith(lastSentText)){
    const delta = current.slice(lastSentText.length).trim();
    if(delta){
      sendText(delta);
      lastSentText = current;
    }
  }else{
    log("âœï¸ æ£€æµ‹åˆ°ç¼–è¾‘å†å²å†…å®¹ï¼šè¯·ç‚¹ã€æ‰‹åŠ¨å‘é€ã€‘å‘é€å…¨æ–‡ï¼ˆè‡ªåŠ¨å¢é‡æš‚åœï¼‰");
  }
}
</script>
</body>
</html>
